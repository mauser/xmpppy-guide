%groupchat.tex
\section{Groupchat}

I suppose most of you have experiences with many-to-many chats like IRC. Jabber has its own many-to-many chat which is implement by two protocols: \textit{groupchat 1.0} and \textit{multi user chat (MUC)}.
The MUC protocol is based on groupchat and allows a lot of advanced features like user privileges and passwort-protected rooms.
Because of the simple implementation groupchat will focused here.
If you need \textit{MUC}, have a look at \textit{http://www.jabber.org/jeps/jep-0045.html}.
\newline
\newline
Using \textit{groupchat 1.0} is very easy because it is based on presence messages.
First we have to think about what we want to do. Let's imagine that we want to join the room "castle\_anthrax" with the nickname "zoot". The server is called "conference.holy-gra.il".
To enter a room, the only thing to do is sending a presence message with the room and your nickname to your conference server.
\newline
To speak in python:
\begin{verbatim}
room = "castle_anthrax@conference.holy-gra.il/zoot"
cl.send(xmpp.Presence(to=room))
\end{verbatim}
Of course it could happen that someone in this room has already chosen the nickname "zoot". This will cause an error 409 ("Conflict") and we have to try another nickname.
\newline
If nobody named "zoot" is in there, we'll receive a presence message from everybody in that room (including yourself).
The "from" attribut of the message looks like this: \textit{castle\_anthrax@conference.holy-gra.il/galahad}, which means that somebody named galahad is already in this room.This might be interesting for you if you write a jabber client and you have to keep track of the nicks in the room.
\newline

Receiving messages is divided in 2 parts. If someone sends a public message, you'll receive a message with the type "groupchat".This message will be sent to every user in that room.A private message is send as a chat type message.
\newline
Sending message is as easy as receiving messages. Just send a groupchat message to the room-jid or send a chat message to a room-member, if you like some private chit-chat..
\newline
\newline
The following example is based on recv.py, the script used in chapter 2: receiving messages.


\begin{verbatim}
#!/usr/bin/python
import sys
import xmpp
import os
import signal
import time

def messageCB(conn,msg):
	if msg.getType() == "groupchat":
		print str(msg.getFrom()) +": "+  str(msg.getBody())
	if msg.getType() == "chat":
		print "private: " + str(msg.getFrom()) +  ":" +str(msg.getBody())

def presenceCB(conn,msg):
	print msg




def StepOn(conn):
    try:
        conn.Process(1)
    except KeyboardInterrupt:
	    return 0
    return 1

def GoOn(conn):
    while StepOn(conn):
	    pass


def main():

	jid="user@domain.tld"
	pwd="secret"

	jid=xmpp.protocol.JID(jid)

	cl = xmpp.Client(jid.getDomain(), debug=[])

	cl.connect()

	cl.auth(jid.getNode(),pwd)


	cl.sendInitPresence()

	cl.RegisterHandler('message', messageCB)

	room = "castle_anthrax@conf.holy-gra.il/zoot"
	print "Joining " + room

	cl.send(xmpp.Presence(to=room))
	cl.send(xmpp.Message(castle_anthrax@conf.holy-gra.il,"zoot is here!","groupchat"))
	cl.send(xmpp.Message(castle_anthrax@conf.holy-gra.il/galahad,"hey sweetheart","chat"))

	GoOn(cl)

main()
\end{verbatim}